{% extends 'base.html.twig' %}

{% set totalHT = 0 %}
{% set volume = 0 %}
{% set poids = 0 %}

{% block title %}Commande - SNIW , centrale d'achat export.{% endblock %}

{% block stylesheet %}
    <link rel="stylesheet" type="text/css" href="/styles/font-awesome/all.css">
{% endblock %}


{% block body %}
    <body>
    <div class="background">
        <div class="columns-container container carriere-container">
            <div class="rte">


                <div class="breadcrumbs d-flex flex-row align-items-center">
                    <ul>
                        <li><a href="{{ path('home') }}">Home</a></li>
                        <li><i class="fa fa-angle-right"></i><a href="{{ path('catalogue') }}">Catalogue</a></li>
                        <li class="active"><i class="fa fa-angle-right" aria-hidden="true"></i>Votre panier</li>

                    </ul>
                </div>
                <h2> Récapitulatif de la commande </h2>
                <table class="table mt-5 table-responsive">
                    <thead>
                    <tr>
                        <th style="width:100px;border: 1px solid #e9ecef">Produit</th>
                        <th style="width:400px;border: 1px solid #e9ecef">Description</th>
                        <th style="width:100px;border: 1px solid #e9ecef">Prix/Carton</th>
                        <th style="width:140px;border: 1px solid #e9ecef">Nb de carton(s)</th>

                        <th style="width:140px;border: 1px solid #e9ecef">Poids produit(s)</th>
                        <th style="width:140px;border: 1px solid #e9ecef">Volume produit(s)</th>
                        <th style="width:90px;border: 1px solid #e9ecef">Total</th>
                        <th style="width:140px;border: 1px solid #e9ecef"> Supprimer</th>
                    </tr>
                    </thead>
                    <tbody>

                    {% if produits|length ==0 %}
                        <tr>
                            <td colspan="6" class="text-center"> Votre panier est vide</td>
                        </tr>
                    {% endif %}

                    {% for produit in produits %}
                        <tr id="produit_{{ produit.id }}">
                            <td style="border: 1px solid #e9ecef">

                                {% if produit.image|length > 0 %}
                                    <img src="{{ asset('produits/images/' ~ produit.image) }}" style="width:100%;" alt="{{ produit.nom }}">
                                {% else %}
                                    <img src="http://{{ produit.getImageImport() }}" style="width:90%;" alt="{{ produit.nom }}">
                                {% endif %}

                            </td>

                            {% set prixTotalProduit =  produit.getPrixFinal() * panier[produit.id] %}
                            {% set poidsP = produit.weight * panier[produit.id] %}
                            {% set volumeP = produit.profondeur * panier[produit.id] %}
                            <form action="{{ path('ajouter',  {'id' : produit.id}) }}" method="get" id="form-qte">

                                <td style="border: 1px solid #e9ecef;text-transform: uppercase"> {{ produit.nom }}
                                    <p style="font-size:11px;text-transform: none"> Référence
                                        : {{ produit.reference }}</p>
                                </td>
                                <td style="border: 1px solid #e9ecef"><span
                                            id="prix">{{ produit.getPrixFinal()|number_format(2, '.','') }}</span>€
                                </td>
                                <td style="border: 1px solid #e9ecef">
                                    <input name="quantite" id="qte" type="text" value="{{ panier[produit.id] }}">
                                </td>
                                <td style="border: 1px solid #e9ecef"><span
                                            id="poidsProd_{{ produit.id }}">{{ poidsP|number_format(2, '.','') }} </span> kg
                                </td>

                                <td style="border: 1px solid #e9ecef"><span
                                            id="volumeTotal_{{ produit.id }}">{{ volumeP|number_format(2, '.','') }}</span>  m3
                                </td>
                                <td style="border: 1px solid #e9ecef"><span
                                            id="prixTotal_{{ produit.id }}">{{ prixTotalProduit|number_format(2, '.','') }} </span>€
                                </td>
                                <td style="border: 1px solid #e9ecef">
                                    <img onclick="suppAjax({{ produit.id }},'/supprimer/ajax/'+{{ produit.id }})" src="{{ asset('images/add-to-cart.png') }}" style="width:40px" >
                                </td>

                            </form>
                        </tr>
                        {% set totalHT = totalHT + (produit.getPrixFinal() * panier[produit.id]) %}
                        {% set volume = volume + (produit.profondeur) * panier[produit.id] %}
                        {% set poids = poids + (produit.weight) * panier[produit.id] %}
                        {% set poidsProduit = produit.weight %}

                    {% endfor %}


                    </tbody>
                </table>

                {% if produits|length !=0 %}

                    <div class="row">
                        <div class="col-md-6">
                        </div>
                        <div class="col-md-6">
                            <table class="table">
                                <tr>
                                    <td style="border: 1px solid #e9ecef"> Volume</td>
                                    <td style="border: 1px solid #e9ecef"> <span id="volumeFinal"> {{ volume|number_format(2, '.','') }} </span> m³</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #e9ecef"> Poids</td>

                                    <td style="border: 1px solid #e9ecef"> <span id="poidsFinal" >{{ poids|number_format(2, '.','')}} </span> kg </td>
                                </tr>

                                <tr>
                                    <td style="border: 1px solid #e9ecef">Total HT</td>
                                    <td style="font-weight: bold;font-size:22px;border: 1px solid #e9ecef" ><span id="prixFinal"> {{ totalHT|number_format(2, '.', '') }} </span>
                                        €
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col">
                            <a class="btn-mj btn-def" href="{{ path('catalogue') }}" style="color:white"> <i
                                        class="fa fa-angle-double-left"></i> Continuer mes achats </a>
                        </div>
                        <div class="col">
                            <a id="submit" class="btn-mj btn-def" href="{{ path('adresses', {id: app.user.id}) }}"
                               style="color:white;float:right"> Envoyer ma demande <i
                                        class="fa fa-angle-double-right"></i> </a>
                        </div>
                    </div>

                {% endif %}

                {% include 'partiels/footer.html.twig' %}
            </div>
        </div>
    </div>
    </body>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="/js/jquery-3.2.1.min.js"></script>

    <script>
        $("document").ready(function () {
            let changement = false;
            $('#qte').change(function () {
                $.ajax({
                        data: {
                            id: $('#qte').val(),
                            produit: $('#prix').text()
                        },
                        type: 'get',
                        url: '',
                        beforeSend: function () {
                        },


                        success: function (data) {
                            $('#total').text($('#qte').val() * parseFloat($('#prix').text()));



                            document.getElementById('form-qte').submit();
                        }
                    }
                );
                $.ajax({
                        data: {
                            id: $('#qte').val(),
                        },
                        type: 'post',
                        url: '',
                        beforeSend: function () {
                        },
                        success: function (data) {
                            $('#total').text($('#qte').val() * parseFloat($('#prix').text()));
                        }
                    }
                )
            })

            })




    </script>

    <script>
        function suppAjax(id,changePath) {
            $.ajax({
                type: "POST",
                url: changePath,
                data : {
                    idproduit: $('#produit_' +id).val()
                },
                dataType: "json",
                success: function(response) {

                    //Supprime avec un effet
                    $('#produit_' +id).fadeOut(300,function() { $("this").remove() });

                    //Enlève 1 au panier
                    let txt = parseInt($('#checkout_items').text());
                    $('#checkout_items').text(txt-1);


                    //Poids produit
                    let poidsProduit = parseFloat($('#poidsProd_'+id).text()).toFixed(2);
                    //Poids final
                    let poidsFinal = parseFloat($('#poidsFinal').text()).toFixed(2);


                    //Volume produit
                    let volumeProduit = parseFloat($('#volumeTotal_'+id).text()).toFixed(2);
                    //Change le volume final
                    let volumeFinal = parseFloat($('#volumeFinal').text()).toFixed(2);


                    //Prix produit
                    let prixProduit = parseFloat($('#prixTotal_'+id).text()).toFixed(2);
                    //Change le prix final
                    let prixFinal = parseFloat($('#prixFinal').text()).toFixed(2);


                    //Si l'on supprime un produit du panier
                    if ( $('#produit_' +id).fadeOut(300,function() { $("this").remove() }) ) {
                        let poidsF = poidsFinal - poidsProduit;
                        parseFloat($('#poidsFinal').text(poidsF.toFixed(2)));

                        let volumeF = volumeFinal - volumeProduit;
                        parseFloat($('#volumeFinal').text(volumeF.toFixed(2)));

                        let prixF = prixFinal - prixProduit;
                        parseFloat($('#prixFinal').text(prixF.toFixed(2)));



                    }
                }
            });
        }
    </script>

{% endblock %}




